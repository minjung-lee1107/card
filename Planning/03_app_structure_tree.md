streamlit.py
â”œâ”€ import
â”‚  â”œâ”€ streamlit as st
â”‚  â”œâ”€ pandas as pd
â”‚  â”œâ”€ numpy as np
â”‚  â”œâ”€ plotly.express as px
â”‚  â”œâ”€ plotly.graph_objects as go
â”‚  â”œâ”€ OpenAI (from openai import OpenAI)
â”‚  â”œâ”€ re
â”‚  â”œâ”€ json
â”‚  â””â”€ difflib
â”‚
â”œâ”€ ğŸ”‘ OpenAI ì„¤ì •
â”‚  â”œâ”€ client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
â”‚  â””â”€ (AI ë¶„ë¥˜/ì¸ì‚¬ì´íŠ¸ì—ì„œ ì‚¬ìš©)
â”‚
â”œâ”€ ğŸ§¹ ë°ì´í„° ì „ì²˜ë¦¬ & ìë™ ë¶„ë¥˜
â”‚  â”‚
â”‚  â”œâ”€ ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì •ì˜
â”‚  â”‚  â”œâ”€ RULES            (í‚¤ì›Œë“œ ë£° ê¸°ë°˜ ë¶„ë¥˜ ì‚¬ì „)
â”‚  â”‚  â””â”€ CATEGORIES       (ìµœì¢… ì¹´í…Œê³ ë¦¬ ëª©ë¡)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ§¼ í…ìŠ¤íŠ¸/ì»¬ëŸ¼ ì •ê·œí™”
â”‚  â”‚  â”œâ”€ _norm_col        (ì»¬ëŸ¼ëª… ë¹„êµìš© ì •ê·œí™”)
â”‚  â”‚  â””â”€ normalize_text   (description í…ìŠ¤íŠ¸ ì •ê·œí™”)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
â”‚  â”‚  â”œâ”€ rule_category        (RULES ê¸°ë°˜ 1ì°¨ ë¶„ë¥˜)
â”‚  â”‚  â”œâ”€ ai_category_batch    (ë¯¸ë¶„ë¥˜ë§Œ OpenAIë¡œ ë°°ì¹˜ ë¶„ë¥˜)
â”‚  â”‚  â””â”€ build_category       (rule â†’ ë¯¸ë¶„ë¥˜ë§Œ AI â†’ ìµœì¢… category)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ—‚ï¸ ì»¬ëŸ¼ ìë™ ë§¤í•‘
â”‚  â”‚  â”œâ”€ STANDARD_COLS    (í‘œì¤€ ìŠ¤í‚¤ë§ˆ)
â”‚  â”‚  â”œâ”€ REQUIRED_COLS    (í•„ìˆ˜ ì»¬ëŸ¼)
â”‚  â”‚  â”œâ”€ SYNONYMS         (í‘œì¤€ ì»¬ëŸ¼ ë™ì˜ì–´ ì‚¬ì „)
â”‚  â”‚  â””â”€ auto_map_columns (ì‚¬ì „ ë§¤í•‘ + difflib ìœ ì‚¬ë„ ë³´ì™„ + ë¶ˆí•„ìš” ì»¬ëŸ¼ drop)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ”„ íƒ€ì… ë³€í™˜ / ê°’ ì •ë¦¬
â”‚  â”‚  â””â”€ coerce_types
â”‚  â”‚     â”œâ”€ date: datetime ë³€í™˜ + ê²°ì¸¡ ì œê±°
â”‚  â”‚     â”œâ”€ amount: ìˆ«ì ë³€í™˜(ì½¤ë§ˆ/ì› ì œê±°) + ê²°ì¸¡ ì œê±°
â”‚  â”‚     â”œâ”€ is_fixed: bool ë³€í™˜
â”‚  â”‚     â””â”€ installment_type/months: ì¼ì‹œë¶ˆÂ·í• ë¶€ ì •ê·œí™”
â”‚  â”‚
â”‚  â””â”€ ğŸš€ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ (ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸)
â”‚     â””â”€ preprocess_any_expense_df
â”‚        â”œâ”€ auto_map_columns
â”‚        â”œâ”€ coerce_types
â”‚        â”œâ”€ í•„ìˆ˜ ì»¬ëŸ¼ ê²€ì‚¬(date/amount/description)
â”‚        â”œâ”€ category ë³´ì •(ì—†ê±°ë‚˜ ë¹„ë©´ build_categoryë¡œ ìƒì„±)
â”‚        â”œâ”€ category í‘œì¤€í™”(ëª©ë¡ ì™¸ â†’ ê¸°íƒ€)
â”‚        â””â”€ íŒŒìƒ ì»¬ëŸ¼ ìƒì„±(month, year_month) + ì»¬ëŸ¼ ì •ë ¬ + report ë°˜í™˜
â”‚
â”œâ”€ ğŸ¨ Streamlit ì´ˆê¸° í™”ë©´/ì—…ë¡œë“œ
â”‚  â”œâ”€ st.set_page_config
â”‚  â”œâ”€ st.title
â”‚  â”‚
â”‚  â”œâ”€ Session State ì´ˆê¸°í™”
â”‚  â”‚  â”œâ”€ st.session_state.df (ì›ë³¸ df_raw)
â”‚  â”‚  â”œâ”€ st.session_state.df_processed (ì „ì²˜ë¦¬ ì™„ë£Œ df)
â”‚  â”‚  â”œâ”€ st.session_state.prep_report (ì „ì²˜ë¦¬ ë¦¬í¬íŠ¸)
â”‚  â”‚  â”œâ”€st.session_state.file_uploaded (ì—…ë¡œë“œ ì—¬ë¶€ í”Œë˜ê·¸)
â”‚  â”‚  â””â”€st.session_state.file_name (ì—…ë¡œë“œ íŒŒì¼ëª…)
â”‚  â”‚
â”‚  â”œâ”€ Sidebar: íŒŒì¼ ì—…ë¡œë“œ
â”‚  â”‚  â””â”€ st.file_uploader (csv/xlsx/xls)
â”‚  â”‚
â”‚  â””â”€ uploaded_file ì²˜ë¦¬
â”‚     â”œâ”€ ìƒˆ íŒŒì¼ ê°ì§€
â”‚     â”‚  â””â”€ (not file_uploaded) OR (file_name != uploaded_file.name)
â”‚     â”œâ”€ íŒŒì¼ ì½ê¸°
â”‚     â”‚  â”œâ”€ csv: utf-8 â†’ ì‹¤íŒ¨ ì‹œ cp949
â”‚     â”‚  â””â”€ excel: read_excel
â”‚     â”œâ”€ Session state ì €ì¥
â”‚     â”‚  â”œâ”€ df_raw â†’ st.session_state.df
â”‚     â”‚  â”œâ”€ file_uploaded/file_name ê°±ì‹ 
â”‚     â”‚  â””â”€df_processed/prep_report = None (ì „ì²˜ë¦¬ ìºì‹œ ë¦¬ì…‹)
â”‚     â”‚ 
â”‚     â””â”€ ì „ì²˜ë¦¬ ì‹¤í–‰ì€ â€œ1íšŒë§Œâ€
â”‚       â”œâ”€ if st.session_state.df_processed is None:
â”‚       â”‚ â”œâ”€ preprocess_any_expense_df(st.session_state.df)
â”‚       â”‚ â”œâ”€ ì‹¤íŒ¨(df is None) ì•ˆë‚´ + ë§¤í•‘ ê²°ê³¼(expander) + st.stop
â”‚       â”‚ â””â”€ ì„±ê³µ ì‹œ df_processed/prep_report ì €ì¥ + success
â”‚       â””â”€ else: ì €ì¥ëœ df_processed/prep_report ì¬ì‚¬ìš©
â”‚
â”œâ”€ ğŸ›ï¸ Sidebar: í•„í„° (ì—…ë¡œë“œ ì´í›„)
â”‚  â”œâ”€ ê¸°ê°„ í•„í„° (st.date_input)
â”‚  â”œâ”€ ì¹´í…Œê³ ë¦¬ í•„í„° (st.multiselect)
â”‚  â””â”€ ì¼ì‹œë¶ˆ/í• ë¶€ í•„í„°(st.multiselect)
â”‚
â”œâ”€ ğŸ“Š ëŒ€ì‹œë³´ë“œ: í•µì‹¬ ì§€í‘œ (Metrics)
â”‚  â”œâ”€ ì´ ì§€ì¶œ
â”‚  â”œâ”€ ì›”í‰ê·  ì§€ì¶œ (ì›”ë³„ í•©ê³„ì˜ mean)
â”‚  â”œâ”€ ìµœëŒ€ ë‹¨ì¼ ì§€ì¶œ
â”‚  â””â”€ ê±°ë˜ ê±´ìˆ˜
â”‚
â”œâ”€ ğŸ“ˆ ëŒ€ì‹œë³´ë“œ: ì°¨íŠ¸ ì˜ì—­
â”‚  â”œâ”€ 2ì—´ ë ˆì´ì•„ì›ƒ (col_left, col_right)
â”‚  â”‚
â”‚  â”œâ”€ (Left) ë„ë„› ì°¨íŠ¸: ì§€ì¶œ êµ¬ì„±
â”‚  â”‚  â”œâ”€ Tab1: ì¹´í…Œê³ ë¦¬ ë„ë„›(px.pie)
â”‚  â”‚  â””â”€ Tab2: í• ë¶€ì—¬ë¶€ ë„ë„›
â”‚  â”‚     â”œâ”€ metric_mode ë¼ë””ì˜¤: ê¸ˆì•¡/ê±´ìˆ˜
â”‚  â”‚     â”œâ”€ pay_type íŒŒìƒ(installment_months ë˜ëŠ” installment_type ê¸°ë°˜)
â”‚  â”‚     â””â”€ ë„ë„›(px.pie)
â”‚  â”‚
â”‚  â””â”€ (Right) ë§‰ëŒ€ ê·¸ë˜í”„: ì¹´í…Œê³ ë¦¬ë³„ ì›” ëˆ„ì  ì§€ì¶œ (ìµœê·¼ 6ê°œì›”, stack)
â”‚
â”œâ”€ ğŸ“† íƒ­í˜• ì¶”ì´ ë¶„ì„
â”‚  â”œâ”€ Tabs: ì›”ë³„ / ì£¼ë³„ / ìš”ì¼ë³„ / ì¼ë³„
â”‚  â”œâ”€ ê³µí†µ í•¨ìˆ˜: draw_line
â”‚  â”œâ”€ ì›”ë³„ ì§€ì¶œ ì¶”ì´ (year_month)
â”‚  â”œâ”€ ì£¼ë³„ ì§€ì¶œ ì¶”ì´ (1~5ì£¼ ë¼ë²¨)
â”‚  â”œâ”€ ì¼ë³„ ì§€ì¶œ ë§‰ëŒ€ê·¸ë˜í”„
â”‚  â”‚  â”œâ”€ ì›” ì„ íƒ(selectbox)
â”‚  â”‚  â”œâ”€ ì¼ë³„ í•©ê³„ + ê±°ë˜ê±´ìˆ˜ ì§‘ê³„
â”‚  â”‚  â”œâ”€ ì£¼ë§/í‰ì¼ ìƒ‰ êµ¬ë¶„
â”‚  â”‚  â””â”€ ìµœê³ ì§€ì¶œì¼ ë§ˆì»¤/í…ìŠ¤íŠ¸ í‘œì‹œ
â”‚  â””â”€ ìš”ì¼ë³„ ì§€ì¶œ íˆíŠ¸ë§µ
â”‚     â”œâ”€ ISO week_key ìƒì„±
â”‚     â”œâ”€ (week_key x weekday) í‰ê·  pivot
â”‚     â””â”€ px.imshow + hoverì— ì‹¤ì œ ë‚ ì§œ ì»¤ìŠ¤í…€ë°ì´í„°
â”‚
â”œâ”€ ğŸ”€ ë¹„êµ ë¶„ì„
â”‚  â””â”€ ì¹´í…Œê³ ë¦¬ë³„ ë‘ ë‹¬ ë¹„êµ + ë³€í™” ìš”ì•½
â”‚     â”œâ”€ month1/month2 ì„ íƒ
â”‚     â”œâ”€ categoryÃ—month pivot + diff ê³„ì‚°
â”‚     â”œâ”€ (Left) ìŠ¬ë¡œí”„/ë¼ì¸ ì°¨íŠ¸(px.line)
â”‚     â””â”€ (Right) Top N ë³€í™” ìš”ì•½ + popover/expander ìƒì„¸
â”‚
â”œâ”€ ğŸ’» ë°ì´í„° ìš”ì•½ í†µê³„
â”‚   â””â”€ generate_expense_summary(df)
â”‚       â”œâ”€ summary ê¸°ë³¸ í†µê³„
â”‚       â”œâ”€ ê°œì›” ìˆ˜ ê³„ì‚°
â”‚       â”œâ”€ ì›” í‰ê·  ì´ ì§€ì¶œ
â”‚       â”œâ”€ ì¹´í…Œê³ ë¦¬ë³„ í†µê³„ + ì›” í‰ê· 
â”‚       â”œâ”€ ì›”ë³„ í†µê³„
â”‚       â””â”€ ë°˜í™˜: summary(dict)
â”‚
â”œâ”€ ğŸ’¡ OPEN AI í´ë¼ì´ì–¸íŠ¸ ìƒì„±
â”‚   â””â”€ get_ai_insights(summary_data)
â”‚       â”œâ”€ ì…ë ¥: summary_data (generate_expense_summary ê²°ê³¼)
â”‚       â”œâ”€ ê¸°ê°„/ì›”í‰ê·  ê°’ í™•ì •
â”‚       â”œâ”€ ì¹´í…Œê³ ë¦¬ breakdown
â”‚       â”œâ”€ AI Prompt êµ¬ì„±
â”‚       â”‚   â”œâ”€ "ì´ (months)ê°œì›” ì¹˜ ë°ì´í„°" ëª…ì‹œ
â”‚       â”‚   â”œâ”€ "ë‹¤ìŒ ë‹¬ ê¶Œì¥ ì˜ˆì‚°ì€ ì›” í‰ê·  ê¸°ì¤€" ê°•ì œ
â”‚       â”‚   â””â”€ ìš”ì•½ ì§€í‘œ, ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ ì‚½ì…
â”‚       â”œâ”€ ë¶„ì„ ìš”ì²­
â”‚       â”‚   â”œâ”€ (1) íŒ¨í„´ 2~3ê°€ì§€
â”‚       â”‚   â”œâ”€ (2) ê°œì„  ë¶€ë¬¸ + ì›” ê¸°ì¤€ ì˜ˆìƒ ì ˆì•½ ê¸ˆì•¡
â”‚       â”‚   â”œâ”€ (3) ë‹¤ìŒ ë‹¬ ê¶Œì¥ ì˜ˆì‚°(ì¹´í…Œê³ ë¦¬ë³„, ì›” ê¸°ì¤€)
â”‚       â”‚   â”œâ”€ (4) 3% ì´ì ê°€ì • 3/6/12ê°œì›” ì €ì¶• ê²°ê³¼(ì •í™• ê¸ˆì•¡)
â”‚       â”œâ”€ AI í˜¸ì¶œ
â”‚       â”‚  â”œâ”€ model="gpt-4o-mini"
â”‚       â”‚  â”œâ”€ user: prompt
â”‚       â”‚  â””â”€ max_tokens=1000
â”‚       â”œâ”€ ê²°ê³¼ ë°˜í™˜
â”‚       â””â”€ ì¶œë ¥
â”‚
â”œâ”€ ğŸ“„ ì›”ê°„ ë¦¬í¬íŠ¸
â”‚   â””â”€ generate_monthly_report (df, insights=None)
â”‚       â”œâ”€ ìš”ì•½ ì§€í‘œ ê³„ì‚°
â”‚       â”‚   â”œâ”€ total_spend
â”‚       â”‚   â”œâ”€ monthly_avg_total
â”‚       â”‚   â”œâ”€ max_spend
â”‚       â”‚   â””â”€ count_tx
â”‚       â”‚
â”‚       â””â”€ ì›”ê°„ ì§€ì¶œ ë¦¬í¬íŠ¸ Prompt êµ¬ì„±
â”‚           â”œâ”€ ìƒì„±ì¼
â”‚           â”‚   â””â”€ {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M')}
â”‚           â”œâ”€ ì§€ì¶œ ìš”ì•½
â”‚           â”‚   â””â”€ ì´ì§€ì¶œ, ì›”í‰ê· ì§€ì¶œ, ìµœëŒ€ë‹¨ì¼ì§€ì¶œ, ê±°ë˜ê±´ìˆ˜
â”‚           â”œâ”€ ì¹´í…Œê³ ë¦¬ë³„ ì§€ì¶œ 
â”‚           â”‚   â””â”€ ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„ + ë¹„ìœ¨ ê³„ì‚°
â”‚           â”œâ”€ ê³ ì •ë¹„ ë¦¬ìŠ¤íŠ¸ 
â”‚           â”‚   â””â”€ is_fixed == True ì§‘ê³„ (í•©ê³„ / íšŸìˆ˜ / í‰ê· )
â”‚           â”œâ”€ ì§€ì¶œ ì§‘ì¤‘ì¼ 
â”‚           â”‚   â””â”€ ì¼ë³„ í•©ê³„ â†’ ìµœê³  ì§€ì¶œì¼ + ìƒìœ„ 5ê±´
â”‚           â”œâ”€ ìƒìœ„ 5ê°œ ì§€ì¶œ
â”‚           â”‚   â””â”€ ê¸ˆì•¡ ê¸°ì¤€ Top5
â”‚           â”œâ”€ AI ì¸ì‚¬ì´íŠ¸
â”‚           â””â”€ return Markdown ë¦¬í¬íŠ¸ ë¬¸ìì—´
â”‚       
â””â”€ ğŸ–¥ï¸ Streamlit UI ì—°ë™
    â”œâ”€ ì¡°ê±´: if uploaded_file is not None
    â”œâ”€ AI ë¶„ì„ ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜
    â”‚  â”œâ”€ ë²„íŠ¼: "ğŸ” AI ë¶„ì„ ì‹œì‘"
    â”‚  â”‚   â”œâ”€ summary = generate_expense_summary(df_filtered)
    â”‚  â”‚   â”œâ”€ insights = get_ai_insights(summary)
    â”‚  â”‚   â”œâ”€ í™”ë©´ ì¶œë ¥
    â”‚  â”‚   â””â”€ session_state['last_insights'] ì €ì¥
    â”‚  â””â”€ ì´ì „ ë¶„ì„ ê²°ê³¼ expander
    â”‚       â””â”€ last_insights ì¬í‘œì‹œ
    â””â”€ ì›”ê°„ ë¦¬í¬íŠ¸ ì„¹ì…˜
        â”œâ”€ ë²„íŠ¼: "ğŸ“„ ë¦¬í¬íŠ¸ ìƒì„±"
        â”‚   â”œâ”€ insights ë¶ˆëŸ¬ì˜¤ê¸°
        â”‚   â”œâ”€ report = generate_monthly_report(df_filtered, insights)
        â”‚   â””â”€ st.markdown(report)
        â”‚
        â””â”€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
            â”œâ”€ íŒŒì¼ëª…: expense_report_YYYYMMDD.md
            â”œâ”€ data=report
            â””â”€ mime="text/markdown"

