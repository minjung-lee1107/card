utils/
â”œâ”€ preprocess.py
â”‚  â”œâ”€ import
â”‚  â”‚  â”œâ”€ pandas as pd
â”‚  â”‚  â”œâ”€ re / json / difflib
â”‚  â”‚  â”œâ”€ typing (Tuple, Dict, Optional ...)
â”‚  â”‚  â”œâ”€ streamlit as st
â”‚  â”‚  â””â”€ OpenAI
â”‚  â”‚
â”‚  â”œâ”€ ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì •ì˜
â”‚  â”‚  â”œâ”€ RULES        (í‚¤ì›Œë“œ ë£° ê¸°ë°˜ ë¶„ë¥˜ ì‚¬ì „)
â”‚  â”‚  â””â”€ CATEGORIES   (ìµœì¢… ì¹´í…Œê³ ë¦¬ ëª©ë¡)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ§¼ í…ìŠ¤íŠ¸/ì»¬ëŸ¼ ì •ê·œí™”
â”‚  â”‚  â”œâ”€ _norm_col()        (ì»¬ëŸ¼ëª… ë¹„êµìš© ì •ê·œí™”)
â”‚  â”‚  â””â”€ normalize_text()   (description í…ìŠ¤íŠ¸ ì •ê·œí™”)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë¡œì§
â”‚  â”‚  â”œâ”€ rule_category()          (RULES ê¸°ë°˜ 1ì°¨ ë¶„ë¥˜)
â”‚  â”‚  â”œâ”€ ai_category_batch()      (OpenAI ë°°ì¹˜ ë¶„ë¥˜)
â”‚  â”‚  â”œâ”€ ai_category_cached()     (ìºì‹œ ê¸°ë°˜ ë‹¨ê±´ ë¶„ë¥˜)
â”‚  â”‚  â”œâ”€ ai_category_batched()    (ì—¬ëŸ¬ ê±´ ë¬¶ìŒ ë¶„ë¥˜)
â”‚  â”‚  â””â”€ build_category()         (rule â†’ ë¯¸ë¶„ë¥˜ë§Œ AI â†’ ìµœì¢… category)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ—‚ï¸ ì»¬ëŸ¼ ìë™ ë§¤í•‘
â”‚  â”‚  â”œâ”€ STANDARD_COLS       (í‘œì¤€ ìŠ¤í‚¤ë§ˆ ì •ì˜)
â”‚  â”‚  â”œâ”€ REQUIRED_COLS       (í•„ìˆ˜ ì»¬ëŸ¼ ì •ì˜)
â”‚  â”‚  â”œâ”€ SYNONYMS            (ë™ì˜ì–´ ì‚¬ì „)
â”‚  â”‚  â””â”€ auto_map_columns()  (ì‚¬ì „ ë§¤í•‘ + difflib ë³´ì™„ + ì˜µì…˜ì— ë”°ë¼ ì»¬ëŸ¼ ì •ë¦¬)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ”„ íƒ€ì… ë³€í™˜ / ê°’ ì •ë¦¬
â”‚  â”‚  â””â”€ coerce_types()
â”‚  â”‚     â”œâ”€ date: datetime ë³€í™˜ + ê²°ì¸¡ ì œì™¸
â”‚  â”‚     â”œâ”€ amount: ìˆ«ì ë³€í™˜(ì½¤ë§ˆ/ì› ì œê±°) + ê²°ì¸¡ ì œì™¸
â”‚  â”‚     â”œâ”€ is_fixed: bool ë³€í™˜
â”‚  â”‚     â””â”€ installment_type / installment_months ì •ê·œí™”
â”‚  â”‚
â”‚  â””â”€ ğŸš€ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ (ì—”íŠ¸ë¦¬)
â”‚     â””â”€ preprocess_any_expense_df()
â”‚        â”œâ”€ auto_map_columns()
â”‚        â”œâ”€ coerce_types()
â”‚        â”œâ”€ í•„ìˆ˜ ì»¬ëŸ¼ ê²€ì‚¬ (date/amount/description)
â”‚        â”œâ”€ category ë³´ì •
â”‚        â”‚  â””â”€ (ì—†ê±°ë‚˜ ë¹„ë©´) build_category()ë¡œ ìƒì„±
â”‚        â”œâ”€ category í‘œì¤€í™” (ëª©ë¡ ì™¸ â†’ "ê¸°íƒ€")
â”‚        â”œâ”€ íŒŒìƒ ì»¬ëŸ¼ ìƒì„± (month, year_month ë“±)
â”‚        â”œâ”€ ì»¬ëŸ¼ ì •ë ¬
â”‚        â””â”€ return: (df_processed, report)
â”‚
â”œâ”€ ai_and_report.py
â”‚  â”œâ”€ ğŸ’¡ AI ì¸ì‚¬ì´íŠ¸
â”‚  â”‚  â””â”€ get_ai_insights(summary_data)
â”‚  â”‚     â”œâ”€ ìš”ì•½ ë°ì´í„° ê¸°ë°˜ Prompt êµ¬ì„±
â”‚  â”‚     â”œâ”€ "ì›” ê¸°ì¤€ ê³„ì‚°" ê°•ì œ
â”‚  â”‚     â”œâ”€ íŒ¨í„´/ê°œì„ /ê¶Œì¥ì˜ˆì‚°/ì´ì ì‹œë®¬ í¬í•¨
â”‚  â”‚     â””â”€ OpenAI í˜¸ì¶œ
â”‚  â”‚        â”œâ”€ model="gpt-4o-mini"
â”‚  â”‚        â”œâ”€ max_tokens=1000
â”‚  â”‚        â””â”€ temperature=...
â”‚  â”‚
â”‚  â””â”€ ğŸ“„ ì›”ê°„ ë¦¬í¬íŠ¸
â”‚     â””â”€ generate_monthly_report(df, insights=None)
â”‚        â”œâ”€ ìš”ì•½ ì§€í‘œ ê³„ì‚°
â”‚        â”œâ”€ ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„/ë¹„ìœ¨
â”‚        â”œâ”€ ê³ ì •ë¹„ ì§‘ê³„
â”‚        â”œâ”€ ìµœê³  ì§€ì¶œì¼
â”‚        â”œâ”€ Top N ì§€ì¶œ
â”‚        â”œâ”€ (ì„ íƒ) AI ì¸ì‚¬ì´íŠ¸ í¬í•¨
â”‚        â””â”€ return: Markdown ë¬¸ìì—´
â”‚
project_root/
â”œâ”€ app.py
â”‚  â”œâ”€ import
â”‚  â”‚  â”œâ”€ streamlit as st
â”‚  â”‚  â”œâ”€ pandas / numpy
â”‚  â”‚  â”œâ”€ plotly.express / plotly.graph_objects
â”‚  â”‚  â”œâ”€ re / json / difflib
â”‚  â”‚  â”œâ”€ OpenAI
â”‚  â”‚  â”œâ”€ preprocess_any_expense_df (from utils.preprocess)
â”‚  â”‚  â””â”€ get_ai_insights, generate_monthly_report (from utils.ai_and_report)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ”‘ OpenAI ì„¤ì •
â”‚  â”‚  â”œâ”€ api_key = st.secrets.get("OPENAI_API_KEY")
â”‚  â”‚  â””â”€ client = OpenAI(api_key) if api_key else None
â”‚  â”‚
â”‚  â”œâ”€ ğŸ¨ Streamlit ì´ˆê¸° ì„¤ì •
â”‚  â”‚  â”œâ”€ st.set_page_config / st.title
â”‚  â”‚  â””â”€ Session State ì´ˆê¸°í™”
â”‚  â”‚     â”œâ”€ df_raw / df_processed / prep_report
â”‚  â”‚     â”œâ”€ file_uploaded / file_name
â”‚  â”‚     â””â”€ last_insights (ì„ íƒ)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ“‚ Sidebar: ì—…ë¡œë“œ/ì˜µì…˜
â”‚  â”‚  â”œâ”€ file_uploader (csv/xlsx/xls)
â”‚  â”‚  â”œâ”€ ì˜µì…˜ í† ê¸€
â”‚  â”‚  â”‚  â”œâ”€ "AI ìë™ ë³´ì • ì‚¬ìš©"
â”‚  â”‚  â”‚  â””â”€ "í‘œì¤€ ì»¬ëŸ¼ ì™¸ ì»¬ëŸ¼ ì‚­ì œ"
â”‚  â”‚  â””â”€ sample data ë‹¤ìš´ë¡œë“œ (csv)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ§¾ ì—…ë¡œë“œ íŒŒì¼ ì²˜ë¦¬ & ì „ì²˜ë¦¬(1íšŒ)
â”‚  â”‚  â”œâ”€ ìƒˆ íŒŒì¼ ê°ì§€ (íŒŒì¼ëª… ë¹„êµ)
â”‚  â”‚  â”œâ”€ íŒŒì¼ ë¡œë“œ
â”‚  â”‚  â”‚  â”œâ”€ csv: utf-8 â†’ ì‹¤íŒ¨ ì‹œ cp949
â”‚  â”‚  â”‚  â””â”€ excel: read_excel
â”‚  â”‚  â”œâ”€ session_state ì €ì¥ (ì›ë³¸/ìƒíƒœ)
â”‚  â”‚  â”œâ”€ preprocess_any_expense_df() ì‹¤í–‰
â”‚  â”‚  â”‚  â”œâ”€ ì‹¤íŒ¨: ì˜¤ë¥˜ ì•ˆë‚´ + ë§¤í•‘ê²°ê³¼ expander + st.stop()
â”‚  â”‚  â”‚  â””â”€ ì„±ê³µ: df_processed/prep_report ì €ì¥
â”‚  â”‚  â””â”€ ì´í›„ rerun: ìºì‹œ ì¬ì‚¬ìš©
â”‚  â”‚
â”‚  â”œâ”€ ğŸ›ï¸ Sidebar: í•„í„°
â”‚  â”‚  â”œâ”€ ê¸°ê°„ (st.date_input)
â”‚  â”‚  â”œâ”€ ì¹´í…Œê³ ë¦¬ (st.multiselect)
â”‚  â”‚  â””â”€ ê²°ì œìœ í˜• (ì¼ì‹œë¶ˆ/í• ë¶€ multiselect)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ“Š ëŒ€ì‹œë³´ë“œ
â”‚  â”‚  â”œâ”€ í•µì‹¬ ì§€í‘œ Metrics
â”‚  â”‚  â”‚  â”œâ”€ ì´ ì§€ì¶œ / ì›”í‰ê·  / ìµœëŒ€ / ê±°ë˜ê±´ìˆ˜
â”‚  â”‚  â””â”€ ì°¨íŠ¸ ì˜ì—­ (2ì—´)
â”‚  â”‚     â”œâ”€ (Left) ë„ë„› ì°¨íŠ¸
â”‚  â”‚     â”‚  â”œâ”€ segmented_control: "ì¹´í…Œê³ ë¦¬" vs "ì¼ì‹œë¶ˆÂ·í• ë¶€"
â”‚  â”‚     â”‚  â”œâ”€ ì¹´í…Œê³ ë¦¬ ë„ë„› (px.pie)
â”‚  â”‚     â”‚  â””â”€ ì¼ì‹œë¶ˆÂ·í• ë¶€ ë„ë„›
â”‚  â”‚     â”‚     â”œâ”€ ê¸ˆì•¡/ê±´ìˆ˜ ì„ íƒ
â”‚  â”‚     â”‚     â””â”€ pay_type ì§‘ê³„ í›„ px.pie
â”‚  â”‚     â””â”€ (Right) ë§‰ëŒ€ ê·¸ë˜í”„
â”‚  â”‚        â””â”€ ì¹´í…Œê³ ë¦¬ë³„ ì›” ëˆ„ì  ì§€ì¶œ (ìµœê·¼ 6ê°œì›”, stack)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ“† ì¶”ì´ ë¶„ì„
â”‚  â”‚  â”œâ”€ segmented_control: ì›”ë³„/ì£¼ë³„/ìš”ì¼ë³„/ì¼ë³„
â”‚  â”‚  â”œâ”€ ê³µí†µ í•¨ìˆ˜: draw_line()
â”‚  â”‚  â”œâ”€ ì›”ë³„ ì¶”ì´ (year_month)
â”‚  â”‚  â”œâ”€ ì£¼ë³„ ì¶”ì´
â”‚  â”‚  â”œâ”€ ì¼ë³„ ë§‰ëŒ€
â”‚  â”‚  â”‚  â”œâ”€ ì›” ì„ íƒ
â”‚  â”‚  â”‚  â”œâ”€ ì¼ë³„ í•©ê³„ + ê±´ìˆ˜
â”‚  â”‚  â”‚  â””â”€ ìµœê³  ì§€ì¶œì¼ í‘œì‹œ
â”‚  â”‚  â””â”€ ìš”ì¼ë³„ íˆíŠ¸ë§µ
â”‚  â”‚     â”œâ”€ ISO week_key ìƒì„±
â”‚  â”‚     â”œâ”€ pivot (week_key x weekday)
â”‚  â”‚     â””â”€ px.imshow
â”‚  â”‚
â”‚  â”œâ”€ ğŸ”€ ë¹„êµ ë¶„ì„
â”‚  â”‚  â”œâ”€ ë‘ ë‹¬ ì„ íƒ
â”‚  â”‚  â”œâ”€ categoryÃ—month pivot + diff
â”‚  â”‚  â”œâ”€ ë³€í™” ì‹œê°í™” (px.line ë“±)
â”‚  â”‚  â””â”€ Top N ë³€í™” ìš”ì•½
â”‚  â”‚
â”‚  â””â”€ ğŸ¤– AI ë¶„ì„ & ë¦¬í¬íŠ¸
â”‚     â”œâ”€ "ğŸ” AI ë¶„ì„ ì‹œì‘" ë²„íŠ¼
â”‚     â”‚  â”œâ”€ summary ìƒì„±
â”‚     â”‚  â”œâ”€ get_ai_insights() í˜¸ì¶œ
â”‚     â”‚  â””â”€ session_state.last_insights ì €ì¥
â”‚     â”œâ”€ ì´ì „ ì¸ì‚¬ì´íŠ¸ expander
â”‚     â”œâ”€ "ğŸ“„ ë¦¬í¬íŠ¸ ìƒì„±" ë²„íŠ¼
â”‚     â”‚  â”œâ”€ generate_monthly_report() í˜¸ì¶œ
â”‚     â”‚  â””â”€ st.markdown ì¶œë ¥
â”‚     â””â”€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
â”‚        â”œâ”€ file_name: expense_report_YYYYMMDD.md
â”‚        â””â”€ mime: text/markdown (ë˜ëŠ” txt ì˜µì…˜)
â”‚
â””â”€ sample_data_code.py
   â”œâ”€ import / ìƒìˆ˜ / ë£° ì •ì˜ (CATEGORY_RULES, MERCHANT_RULES ...)
   â”œâ”€ ìœ í‹¸: random_date(), random_amount(), get_merchant()
   â”œâ”€ make_sample_expense_data()  (ìƒ˜í”Œ DataFrame ìƒì„±)
   â”œâ”€ save_sample_csv()           (CSV ì €ì¥)
   â””â”€ if __name__ == "__main__":  (ë¡œì»¬ ì‹¤í–‰ ì—”íŠ¸ë¦¬)