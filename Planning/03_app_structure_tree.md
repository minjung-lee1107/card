preprocess.py
â”œâ”€ import
â”‚  â”œâ”€ pandas as pd
â”‚  â”œâ”€ re
â”‚  â”œâ”€ json
â”‚  â”œâ”€ difflib
â”‚  â”œâ”€ OpenAI
â”‚  â”œâ”€ typing (Tuple, Dict)
â”‚  â””â”€ streamlit as st
â”‚
â”œâ”€ ğŸ§¹ ë°ì´í„° ì „ì²˜ë¦¬ & ìë™ ë¶„ë¥˜
â”‚  â”‚
â”‚  â”œâ”€ ğŸ“‚ ì¹´í…Œê³ ë¦¬ ì •ì˜
â”‚  â”‚  â”œâ”€ RULES            (í‚¤ì›Œë“œ ë£° ê¸°ë°˜ ë¶„ë¥˜ ì‚¬ì „)
â”‚  â”‚  â””â”€ CATEGORIES       (ìµœì¢… ì¹´í…Œê³ ë¦¬ ëª©ë¡)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ§¼ í…ìŠ¤íŠ¸/ì»¬ëŸ¼ ì •ê·œí™”
â”‚  â”‚  â”œâ”€ _norm_col        (ì»¬ëŸ¼ëª… ë¹„êµìš© ì •ê·œí™”)
â”‚  â”‚  â””â”€ normalize_text   (description í…ìŠ¤íŠ¸ ì •ê·œí™”)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ·ï¸ ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜
â”‚  â”‚  â”œâ”€ rule_category            (RULES ê¸°ë°˜ 1ì°¨ ë¶„ë¥˜)
â”‚  â”‚  â”œâ”€ ai_category_batch        (OpenAI ë°°ì¹˜ ë¶„ë¥˜)
â”‚  â”‚  â”œâ”€ ai_category_cached       (ìºì‹œ ê¸°ë°˜ ë‹¨ê±´ ë¶„ë¥˜)
â”‚  â”‚  â”œâ”€ ai_category_batched      (ì—¬ëŸ¬ ê±´ ë¬¶ìŒ ë¶„ë¥˜)
â”‚  â”‚  â””â”€ build_category           (rule â†’ ë¯¸ë¶„ë¥˜ë§Œ AI â†’ ìµœì¢… category)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ—‚ï¸ ì»¬ëŸ¼ ìë™ ë§¤í•‘
â”‚  â”‚  â”œâ”€ STANDARD_COLS    (í‘œì¤€ ìŠ¤í‚¤ë§ˆ ì •ì˜)
â”‚  â”‚  â”œâ”€ REQUIRED_COLS    (í•„ìˆ˜ ì»¬ëŸ¼ ì •ì˜)
â”‚  â”‚  â”œâ”€ SYNONYMS         (í‘œì¤€ ì»¬ëŸ¼ ë™ì˜ì–´ ì‚¬ì „)
â”‚  â”‚  â””â”€ auto_map_columns (ì‚¬ì „ ë§¤í•‘ + difflib ìœ ì‚¬ë„ ë³´ì™„ + ë¶ˆí•„ìš” ì»¬ëŸ¼ drop)
â”‚  â”‚
â”‚  â”œâ”€ ğŸ”„ íƒ€ì… ë³€í™˜ / ê°’ ì •ë¦¬
â”‚  â”‚  â””â”€ coerce_types
â”‚  â”‚     â”œâ”€ date: datetime ë³€í™˜ + ê²°ì¸¡ ì œê±°
â”‚  â”‚     â”œâ”€ amount: ìˆ«ì ë³€í™˜(ì½¤ë§ˆ/ì› ì œê±°) + ê²°ì¸¡ ì œê±°
â”‚  â”‚     â”œâ”€ is_fixed: bool ë³€í™˜
â”‚  â”‚     â””â”€ installment_type/months ì •ê·œí™”
â”‚  â”‚
â”‚  â””â”€ ğŸš€ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ (ì—”íŠ¸ë¦¬ í¬ì¸íŠ¸)
â”‚     â””â”€ preprocess_any_expense_df
â”‚        â”œâ”€ auto_map_columns
â”‚        â”œâ”€ coerce_types
â”‚        â”œâ”€ í•„ìˆ˜ ì»¬ëŸ¼ ê²€ì‚¬(date/amount/description)
â”‚        â”œâ”€ category ë³´ì •(ì—†ê±°ë‚˜ ë¹„ë©´ build_categoryë¡œ ìƒì„±)
â”‚        â”œâ”€ category í‘œì¤€í™”(ëª©ë¡ ì™¸ â†’ ê¸°íƒ€)
â”‚        â”œâ”€ íŒŒìƒ ì»¬ëŸ¼ ìƒì„±(month, year_month ë“±)
â”‚        â”œâ”€ ì»¬ëŸ¼ ì •ë ¬
â”‚        â””â”€ ë°˜í™˜: (df_processed, report)
â”‚
app.py
â”œâ”€ import
â”‚  â”œâ”€ streamlit as st
â”‚  â”œâ”€ pandas as pd
â”‚  â”œâ”€ numpy as np
â”‚  â”œâ”€ plotly.express as px
â”‚  â”œâ”€ plotly.graph_objects as go
â”‚  â”œâ”€ OpenAI
â”‚  â”œâ”€ re / json / difflib
â”‚  â””â”€ preprocess_any_expense_df (from utils.preprocess)
â”‚
â”œâ”€ ğŸ”‘ OpenAI ì„¤ì •
â”‚  â”œâ”€ api_key = st.secrets.get("OPENAI_API_KEY")
â”‚  â””â”€ client = OpenAI(api_key) if ì¡´ì¬ ì‹œ
â”‚
â”œâ”€ ğŸ¨ Streamlit ì´ˆê¸° ì„¤ì •
â”‚  â”œâ”€ st.set_page_config
â”‚  â”œâ”€ st.title
â”‚  â””â”€ Session State ì´ˆê¸°í™”
â”‚     â”œâ”€ df_raw
â”‚     â”œâ”€ df_processed
â”‚     â”œâ”€ prep_report
â”‚     â”œâ”€ file_uploaded
â”‚     â””â”€ file_name
â”‚
â”œâ”€ ğŸ“‚ íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­
â”‚  â”œâ”€ Sidebar: st.file_uploader (csv/xlsx/xls)
â”‚  â”œâ”€ ì˜µì…˜ í† ê¸€
â”‚  â”‚  â”œâ”€ AI ìë™ ë³´ì • ì‚¬ìš©
â”‚  â”‚  â””â”€ í‘œì¤€ ì»¬ëŸ¼ ì™¸ ì»¬ëŸ¼ ì‚­ì œ
â”‚  â”‚
â”‚  â””â”€ uploaded_file ì²˜ë¦¬
â”‚     â”œâ”€ ìƒˆ íŒŒì¼ ê°ì§€ (íŒŒì¼ëª… ë¹„êµ)
â”‚     â”œâ”€ íŒŒì¼ ì½ê¸°
â”‚     â”‚  â”œâ”€ csv â†’ utf-8 â†’ ì‹¤íŒ¨ ì‹œ cp949
â”‚     â”‚  â””â”€ excel â†’ read_excel
â”‚     â”œâ”€ session_state ì €ì¥
â”‚     â”œâ”€ ì „ì²˜ë¦¬ ì‹¤í–‰ (1íšŒë§Œ)
â”‚     â”‚   â”œâ”€ preprocess_any_expense_df í˜¸ì¶œ
â”‚     â”‚   â”œâ”€ ì‹¤íŒ¨ ì‹œ ì˜¤ë¥˜ ì•ˆë‚´ + ë§¤í•‘ ê²°ê³¼ expander + st.stop
â”‚     â”‚   â””â”€ ì„±ê³µ ì‹œ df_processed/prep_report ì €ì¥
â”‚     â””â”€ ì´í›„ ì¬ì‹¤í–‰ ì‹œ ìºì‹œ ì¬ì‚¬ìš©
â”‚
â”œâ”€ ğŸ›ï¸ Sidebar: í•„í„°
â”‚  â”œâ”€ ê¸°ê°„ í•„í„° (st.date_input)
â”‚  â”œâ”€ ì¹´í…Œê³ ë¦¬ í•„í„° (st.multiselect)
â”‚  â””â”€ ì¼ì‹œë¶ˆ/í• ë¶€ í•„í„° (installment_type ê¸°ë°˜ multiselect)
â”‚
â”œâ”€ ğŸ“Š ëŒ€ì‹œë³´ë“œ: í•µì‹¬ ì§€í‘œ (Metrics)
â”‚  â”œâ”€ ì´ ì§€ì¶œ
â”‚  â”œâ”€ ì›”í‰ê·  ì§€ì¶œ
â”‚  â”œâ”€ ìµœëŒ€ ë‹¨ì¼ ì§€ì¶œ
â”‚  â””â”€ ê±°ë˜ ê±´ìˆ˜
â”‚
â”œâ”€ ğŸ“ˆ ëŒ€ì‹œë³´ë“œ: ì°¨íŠ¸ ì˜ì—­
â”‚  â”œâ”€ 2ì—´ ë ˆì´ì•„ì›ƒ (col_left, col_right)
â”‚  â”‚
â”‚  â”œâ”€ (Left) ë„ë„› ì°¨íŠ¸
â”‚  â”‚  â”œâ”€ st.segmented_control
â”‚  â”‚  â”‚   â””â”€ ì¹´í…Œê³ ë¦¬ / ì¼ì‹œë¶ˆÂ·í• ë¶€ ì „í™˜
â”‚  â”‚  â”œâ”€ ì¹´í…Œê³ ë¦¬ ë„ë„› (px.pie)
â”‚  â”‚  â””â”€ ì¼ì‹œë¶ˆÂ·í• ë¶€ ë„ë„›
â”‚  â”‚     â”œâ”€ ê¸ˆì•¡/ê±´ìˆ˜ ì„ íƒ
â”‚  â”‚     â””â”€ pay_type ì§‘ê³„ í›„ px.pie
â”‚  â”‚
â”‚  â””â”€ (Right) ë§‰ëŒ€ ê·¸ë˜í”„
â”‚     â””â”€ ì¹´í…Œê³ ë¦¬ë³„ ì›” ëˆ„ì  ì§€ì¶œ (ìµœê·¼ 6ê°œì›”, stack)
â”‚
â”œâ”€ ğŸ“† ì¶”ì´ ë¶„ì„
â”‚  â”œâ”€ st.segmented_control
â”‚  â”‚   â””â”€ ì›”ë³„ / ì£¼ë³„ / ìš”ì¼ë³„ / ì¼ë³„
â”‚  â”‚
â”‚  â”œâ”€ ê³µí†µ í•¨ìˆ˜: draw_line
â”‚  â”œâ”€ ì›”ë³„ ì§€ì¶œ ì¶”ì´ (year_month)
â”‚  â”œâ”€ ì£¼ë³„ ì§€ì¶œ ì¶”ì´
â”‚  â”œâ”€ ì¼ë³„ ì§€ì¶œ ë§‰ëŒ€ê·¸ë˜í”„
â”‚  â”‚   â”œâ”€ ì›” ì„ íƒ(selectbox)
â”‚  â”‚   â”œâ”€ ì¼ë³„ í•©ê³„ + ê±°ë˜ê±´ìˆ˜
â”‚  â”‚   â”œâ”€ ì£¼ë§/í‰ì¼ ìƒ‰ êµ¬ë¶„
â”‚  â”‚   â””â”€ ìµœê³ ì§€ì¶œì¼ í‘œì‹œ
â”‚  â”‚
â”‚  â””â”€ ìš”ì¼ë³„ ì§€ì¶œ íˆíŠ¸ë§µ
â”‚      â”œâ”€ ISO week_key ìƒì„±
â”‚      â”œâ”€ (week_key x weekday) pivot
â”‚      â””â”€ px.imshow
â”‚
â”œâ”€ ğŸ”€ ë¹„êµ ë¶„ì„
â”‚  â”œâ”€ ë‘ ë‹¬ ì„ íƒ
â”‚  â”œâ”€ categoryÃ—month pivot + diff ê³„ì‚°
â”‚  â”œâ”€ ìŠ¬ë¡œí”„/ë¼ì¸ ì°¨íŠ¸ (px.line)
â”‚  â””â”€ Top N ë³€í™” ìš”ì•½
â”‚
â”œâ”€ ğŸ’» ë°ì´í„° ìš”ì•½ í†µê³„
â”‚  â””â”€ generate_expense_summary
â”‚     â”œâ”€ ê¸°ë³¸ í†µê³„
â”‚     â”œâ”€ ê°œì›” ìˆ˜ ê³„ì‚°
â”‚     â”œâ”€ ì›” í‰ê·  ì´ì§€ì¶œ
â”‚     â”œâ”€ ì¹´í…Œê³ ë¦¬ë³„ í†µê³„
â”‚     â””â”€ ë°˜í™˜: summary(dict)
â”‚
â”‚
ai_and_report.py
â”œâ”€ ğŸ’¡ AI ì¸ì‚¬ì´íŠ¸
â”‚  â””â”€ get_ai_insights(summary_data)
â”‚     â”œâ”€ ìš”ì•½ ë°ì´í„° ê¸°ë°˜ Prompt êµ¬ì„±
â”‚     â”œâ”€ ì›” ê¸°ì¤€ ê³„ì‚° ê°•ì œ
â”‚     â”œâ”€ íŒ¨í„´/ê°œì„ ë¶€ë¬¸/ê¶Œì¥ì˜ˆì‚°/ì´ì ì‹œë®¬ í¬í•¨
â”‚     â”œâ”€ OpenAI í˜¸ì¶œ
â”‚     â”‚   â”œâ”€ model="gpt-4o-mini"
â”‚     â”‚   â”œâ”€ max_tokens=1000
â”‚     â”‚   â””â”€ temperature ì„¤ì •
â”‚     â””â”€ ê²°ê³¼ ë°˜í™˜
â”‚
â”œâ”€ ğŸ“„ ì›”ê°„ ë¦¬í¬íŠ¸
â”‚  â””â”€ generate_monthly_report(df, insights=None)
â”‚     â”œâ”€ ìš”ì•½ ì§€í‘œ ê³„ì‚°
â”‚     â”œâ”€ ì¹´í…Œê³ ë¦¬ë³„ í•©ê³„ + ë¹„ìœ¨
â”‚     â”œâ”€ ê³ ì •ë¹„ ì§‘ê³„
â”‚     â”œâ”€ ìµœê³  ì§€ì¶œì¼
â”‚     â”œâ”€ Top5 ì§€ì¶œ
â”‚     â”œâ”€ AI ì¸ì‚¬ì´íŠ¸ í¬í•¨
â”‚     â””â”€ Markdown ë¬¸ìì—´ ë°˜í™˜
â”‚
app.py
â””â”€ ğŸ–¥ï¸ UI ì—°ë™
    â”œâ”€ "ğŸ” AI ë¶„ì„ ì‹œì‘" ë²„íŠ¼
    â”‚   â”œâ”€ summary ìƒì„±
    â”‚   â”œâ”€ get_ai_insights í˜¸ì¶œ
    â”‚   â””â”€ session_state ì €ì¥
    â”‚
    â”œâ”€ ì´ì „ ì¸ì‚¬ì´íŠ¸ expander
    â”‚
    â”œâ”€ "ğŸ“„ ë¦¬í¬íŠ¸ ìƒì„±" ë²„íŠ¼
    â”‚   â”œâ”€ generate_monthly_report í˜¸ì¶œ
    â”‚   â”œâ”€ st.markdown ì¶œë ¥   
    â”‚   â””â”€ st.txt ì¶œë ¥
    â”‚
    â””â”€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼
        â”œâ”€ íŒŒì¼ëª…: expense_report_YYYYMMDD.md
        â””â”€ mime="text/markdown"