streamlit.py
├─ import
│  ├─ streamlit as st
│  ├─ pandas as pd
│  ├─ numpy as np
│  ├─ plotly.express as px
│  ├─ plotly.graph_objects as go
│  ├─ OpenAI (from openai import OpenAI)
│  ├─ re
│  ├─ json
│  └─ difflib
│
├─ 🔑 OpenAI 설정
│  ├─ client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
│  └─ (AI 분류/인사이트에서 사용)
│
├─ 🧹 데이터 전처리 & 자동 분류
│  │
│  ├─ 📂 카테고리 정의
│  │  ├─ RULES            (키워드 룰 기반 분류 사전)
│  │  └─ CATEGORIES       (최종 카테고리 목록)
│  │
│  ├─ 🧼 텍스트/컬럼 정규화
│  │  ├─ _norm_col        (컬럼명 비교용 정규화)
│  │  └─ normalize_text   (description 텍스트 정규화)
│  │
│  ├─ 🏷️ 카테고리 분류
│  │  ├─ rule_category        (RULES 기반 1차 분류)
│  │  ├─ ai_category_batch    (미분류만 OpenAI로 배치 분류)
│  │  └─ build_category       (rule → 미분류만 AI → 최종 category)
│  │
│  ├─ 🗂️ 컬럼 자동 매핑
│  │  ├─ STANDARD_COLS    (표준 스키마)
│  │  ├─ REQUIRED_COLS    (필수 컬럼)
│  │  ├─ SYNONYMS         (표준 컬럼 동의어 사전)
│  │  └─ auto_map_columns (사전 매핑 + difflib 유사도 보완 + 불필요 컬럼 drop)
│  │
│  ├─ 🔄 타입 변환 / 값 정리
│  │  └─ coerce_types
│  │     ├─ date: datetime 변환 + 결측 제거
│  │     ├─ amount: 숫자 변환(콤마/원 제거) + 결측 제거
│  │     ├─ is_fixed: bool 변환
│  │     └─ installment_type/months: 일시불·할부 정규화
│  │
│  └─ 🚀 전처리 파이프라인 (엔트리 포인트)
│     └─ preprocess_any_expense_df
│        ├─ auto_map_columns
│        ├─ coerce_types
│        ├─ 필수 컬럼 검사(date/amount/description)
│        ├─ category 보정(없거나 비면 build_category로 생성)
│        ├─ category 표준화(목록 외 → 기타)
│        └─ 파생 컬럼 생성(month, year_month) + 컬럼 정렬 + report 반환
│
├─ 🎨 Streamlit UI (초기 화면/업로드)
│  ├─ st.set_page_config
│  ├─ st.title
│  ├─ Sidebar: 파일 업로드
│  │  └─ st.file_uploader (csv/xlsx/xls)
│  └─ uploaded_file 처리
│     ├─ 파일 읽기
│     │  ├─ csv: utf-8 → 실패 시 cp949
│     │  └─ excel: read_excel
│     ├─ preprocess_any_expense_df 호출
│     ├─ 전처리 실패 안내 + 매핑 결과(expander) + st.stop
│     ├─ 전처리 성공 안내 + 매핑/삭제 컬럼/미리보기(expanders)
│     └─ (업로드 전) 안내/사용방법/FAQ 탭 구성
│
├─ 🎛️ Sidebar: 필터 (업로드 이후)
│  ├─ 기간 필터 (st.date_input)
│  └─ 카테고리 필터 (st.multiselect)
│
├─ 📊 대시보드: 핵심 지표 (Metrics)
│  ├─ 총 지출
│  ├─ 월평균 지출 (월별 합계의 mean)
│  ├─ 최대 단일 지출
│  └─ 거래 건수
│
├─ 📈 대시보드: 차트 영역
│  ├─ 2열 레이아웃 (col_left, col_right)
│  │
│  ├─ (Left) 도넛 차트: 지출 구성
│  │  ├─ Tab1: 카테고리 도넛(px.pie)
│  │  └─ Tab2: 할부여부 도넛
│  │     ├─ metric_mode 라디오: 금액/건수
│  │     ├─ pay_type 파생(installment_months 또는 installment_type 기반)
│  │     └─ 도넛(px.pie)
│  │
│  └─ (Right) 막대 그래프: 카테고리별 월 누적 지출 (최근 6개월, stack)
│
├─ 📆 탭형 추이 분석
│  ├─ Tabs: 월별 / 주별 / 요일별 / 일별
│  ├─ 공통 함수: draw_line
│  ├─ 월별 지출 추이 (year_month)
│  ├─ 주별 지출 추이 (1~5주 라벨)
│  ├─ 일별 지출 막대그래프
│  │  ├─ 월 선택(selectbox)
│  │  ├─ 일별 합계 + 거래건수 집계
│  │  ├─ 주말/평일 색 구분 + 평균선 값 계산
│  │  └─ 최고지출일 마커/텍스트 표시
│  └─ 요일별 지출 히트맵
│     ├─ ISO week_key 생성
│     ├─ (week_key x weekday) 평균 pivot
│     └─ px.imshow + hover에 실제 날짜 커스텀데이터
│
├─ 🔀 비교 분석
│  └─ 카테고리별 두 달 비교 + 변화 요약
│     ├─ month1/month2 선택
│     ├─ category×month pivot + diff 계산
│     ├─ (Left) 슬로프/라인 차트(px.line)
│     └─ (Right) Top N 변화 요약 + popover/expander 상세
