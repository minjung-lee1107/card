# streamlit.py 구조 정리 (Streamlit 개인 지출 분석)

## 1) Import
- `streamlit as st` : UI 구성
- `pandas as pd` : 데이터 처리 및 집계
- `numpy as np` : 수치 연산 및 결측값 처리
- `plotly.express as px` : 인터랙티브 차트 시각화
- `OpenAI` : AI 기반 카테고리 분류 호출
- `re` : 텍스트 정규화 (정규표현식)
- `json` : AI 응답 파싱
- `difflib` : 컬럼명 유사도 비교

---

## 2) 자동 전처리 / 분류 로직

### 2-1. 카테고리 규칙 데이터
- `RULES`
  - 규칙 기반 카테고리 분류용 키워드 사전
- `CATEGORIES`
  - 최종 카테고리 후보 목록
  - AI 분류 및 후처리 단계에서도 해당 목록만 허용

---

### 2-2. 컬럼명 정규화 (자동 매핑용)
- `def _norm_col(x: str) -> str`
  - 컬럼명 비교를 위한 표준화 함수
  - 소문자 변환 + 공백 제거 + 특수문자 제거

---

### 2-3. 텍스트 정규화 (설명 / 가맹점 비교용)
- `def normalize_text(x)`
  - 지출 내역(description) 정규화
  - 소문자 변환 + 연속 공백을 1칸으로 정리

---

### 2-4. 규칙 기반 카테고리 분류
- `def rule_category(description: str) -> str`
  - RULES에 정의된 키워드 포함 여부로 카테고리 결정
  - 어떤 규칙에도 매칭되지 않을 경우 `"미분류"` 반환

---

### 2-5. AI 기반 카테고리 보완 분류
- `def ai_category_batch(...)`
  - 규칙 기반 분류 결과가 `"미분류"`인 항목만 AI 분류 수행
  - 여러 가맹점명을 배치 처리하여 API 호출 최소화
  - `{가맹점명: 카테고리}` 형태의 JSON 반환

- `def build_category(df)`
  - 규칙 기반 분류 → AI 분류 순으로 카테고리 생성
  - AI 결과와 기존 결과 병합
  - 최종 카테고리는 `CATEGORIES` 목록 내 값만 유지

---

### 2-6. 컬럼 자동 매핑
- `STANDARD_COLS`
  - 내부 표준 컬럼 스키마 정의
- `REQUIRED_COLS`
  - 전처리를 위해 반드시 필요한 필수 컬럼 목록
- `SYNONYMS`
  - 표준 컬럼과 사용자 파일 컬럼 간 동의어 사전

- `def auto_map_columns(df)`
  - 업로드된 데이터의 컬럼명을 표준 스키마에 자동 매핑
  - 사전 매핑 → 유사도(difflib) 비교 순으로 처리
  - 매핑되지 않은 불필요 컬럼 제거

---

### 2-7. 타입 변환 및 데이터 정제
- `def coerce_types(df)`
  - 분석에 적합한 데이터 타입으로 변환
  - 날짜 컬럼: datetime 변환
  - 금액 컬럼: 문자 제거 후 숫자형 변환
  - 결측값 및 비정상 데이터 제거

---

### 2-8. 전처리 파이프라인 (엔트리 포인트)
- `def preprocess_any_expense_df(df)`
  - 다양한 형식의 지출 데이터를 공통 스키마로 변환
  - 컬럼 자동 매핑 → 타입 변환 → 카테고리 생성 순으로 처리
  - 필수 컬럼 누락 시 오류 메시지 및 자동 매핑 결과 안내

---

## 3) Streamlit UI

### 3-1. 기본 화면 설정
- `st.set_page_config`
  - 페이지 제목, 아이콘, 레이아웃 설정
- `st.sidebar`
  - 파일 업로드 및 필터 영역 구성

---

### 3-2. 파일 업로드 및 전처리
- `st.file_uploader`
  - CSV / Excel 파일 업로드 지원
- 업로드 후 자동 전처리 파이프라인 실행
- 전처리 실패 시 누락 컬럼 및 매핑 결과 안내

---

## 4) 지표 및 시각화

### 4-1. 핵심 지표 (KPI)
- 총 지출
- 월평균 지출
- 최대 단일 지출
- 거래 건수

---

### 4-2. 지출 구성 분석
- 카테고리별 지출 구성 도넛차트
- 할부 / 일시불 지출 구성 도넛차트
  - 금액 기준 / 건수 기준 토글 지원

---

### 4-3. 누적 및 추이 분석
- 카테고리별 월 누적 지출 막대그래프
- 월별 지출 추이
- 주별 지출 추이
- 요일별 지출 히트맵
- 일별 지출 막대그래프

---

### 4-4. 비교 분석
- 카테고리별 두 달 비교 그래프
- 카테고리별 전월 대비 변화 요약

---
