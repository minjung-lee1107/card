# app.py 구조 정리 (Streamlit 개인 지출 분석)

## 1) Import
- `streamlit as st` : UI 구성
- `pandas as pd` : 데이터 처리
- `plotly.express as px` : 시각화
- `OpenAI` : AI 분류 호출
- `re, json, difflib` : 텍스트 정규화/파싱/유사도 매칭

---

## 2) 자동 전처리 / 분류 로직

### 2-1. 카테고리 규칙 데이터
- `RULES`
  - 규칙 기반 카테고리 분류용 키워드 사전
- `CATEGORIES`
  - 최종 카테고리 후보 목록 (AI/후처리에서 이 목록만 허용)

---

### 2-2. 컬럼명 정규화 (자동 매핑용)
- `def _norm_col(x: str) -> str`
  - 컬럼명 비교를 위한 표준화
  - 소문자 변환 + 공백 제거 + 특수문자 제거

---

### 2-3. 텍스트 정규화 (설명/가맹점 비교용)
- `def normalize_text(x)`
  - description(내역) 정규화
  - 소문자 + 공백 정리 (연속 공백 1칸으로)

---

### 2-4. 규칙 기반 카테고리 분류
- `def rule_category(description: str) -> str`
  - RULES 키워드 포함 여부로 카테고리 결정
  - 실패 시 `"미분류"` 반환

---

### 2-5. AI 기반 카테고리 분류 (배치)
- `def ai_category_batch(descriptions, api_key, model="gpt-4o-mini")`
  - `"미분류"`인 항목만 AI로 보완 분류
  - 프롬프트 규칙:
    - 카테고리는 `CATEGORIES` 중 하나만
    - 애매하면 `"기타"`
    - 출력은 JSON만
    - key는 입력 description 그대로 유지
  - 응답 JSON 파싱 실패 시 `{...}` 영역만 잘라 재시도
  - 최종적으로 `CATEGORIES` 밖이면 `"기타"`로 강제

> ⚠️ 참고: 함수 인자로 `api_key`를 받지만, 현재 구현은 `OpenAI(api_key=st.secrets["OPENAI_API_KEY"])`를 사용 중

---

### 2-6. 규칙 + AI 결합해서 최종 category 만들기
- `def build_category(df, api_key, desc_col="description")`
  1) `category_rule` 생성 (rule_category)
  2) `category_rule == "미분류"`만 모아 `ai_category_batch` 호출
  3) 최종 `category` 생성
     - 규칙 성공이면 규칙값
     - 규칙 실패면 AI값 (없으면 `"기타"`)

---

### 2-7. 컬럼 자동 매핑 (표준 스키마로 정리)
- 표준 컬럼 정의
  - `STANDARD_COLS`
  - `REQUIRED_COLS`
- 동의어 사전
  - `SYNONYMS` : date/amount/category/description 등 다양한 원본 컬럼명 대응
- `def auto_map_columns(df: pd.DataFrame)`
  - 1차: SYNONYMS 기반 매핑
  - 2차: difflib 유사도 기반 보완 매핑 (cutoff=0.86)
  - 표준 스키마 외 컬럼은 drop
  - 반환:
    - `df2`(정리된 df), `mapping`(원본→표준), `dropped`(삭제 컬럼 목록)

---

### 2-8. 타입 강제 변환 / 값 정리
- `def coerce_types(df: pd.DataFrame) -> pd.DataFrame`
  - `date`: datetime 변환 + NaT 제거
  - `amount`: 콤마/원 제거 후 numeric 변환 + NaN 제거
  - `is_fixed`: 다양한 입력을 bool로 변환 (`_to_bool`)
  - `installment_type`: 할부/일시불 표준화 (`_norm_inst`)
  - `installment_months`: numeric 변환, 할부 아닌데 개월수 있으면 NA 처리
  - 문자열 컬럼( category/description/sub_category/payment_method ):
    - strip + 빈값/nan/None 처리

---

### 2-9. 최종 전처리 파이프라인 (엔트리 포인트)
- `def preprocess_any_expense_df(df: pd.DataFrame, api_key: str)`
  처리 단계:
  1) `auto_map_columns` (매핑 + drop)  
  2) `coerce_types` (타입 정리)  
  3) 필수 컬럼 확인: `date, amount, description` 없으면 에러  
  4) category 없거나 비어있거나 `"미분류"`면 `build_category`로 생성  
  5) category 값은 `CATEGORIES`에 없으면 `"기타"`로 강제  
  6) `month`, `year_month` 파생 컬럼 생성  
  7) 컬럼 순서 정렬 후 반환  

  반환:
  - `df_final`, `report(dict)`
    - `column_mapping`, `dropped_columns`, `columns_after_mapping`, `rows_final` 등 포함
